<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.68.3" />


<title>Forward Mode AD in R - Bayesian Statistics and Functional Programming </title>
<meta property="og:title" content="Forward Mode AD in R - Bayesian Statistics and Functional Programming ">



  








<link href='//cdn.bootcss.com/highlight.js/9.11.0/styles/tomorrow-night-eighties.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/picture_cropped.jpg"
         width="50"
         height="50"
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="/blog/">Blog</a></li>
    
    <li><a href="https://github.com/jonnylaw">GitHub</a></li>
    
    <li><a href="https://twitter.com/lawsy">Twitter</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    <h1 class="article-title">Forward Mode AD in R</h1>

    

    <div class="article-content">
      


<div id="forward-mode-automatic-differentation" class="section level2">
<h2>Forward Mode Automatic Differentation</h2>
<p>Automatic differentiation can be used to calculate the exact derivative of a function at a point using applications of the chain rule. Dual numbers provide a straightforward implementation in R using S3 generic methods. A dual number has a real component and a “dual” component which can be used to exacly calculate the expression and derivative at a specific value of <span class="math inline">\(x\)</span>. Consider the quadratic form <span class="math inline">\(f(x) = 5x^2 + 3x + 10\)</span> with derivative <span class="math inline">\(f^\prime(x) = 10x + 3\)</span>. The function and derivative can be evaulated at a value, say <span class="math inline">\(x = 5\)</span> using the dual number <span class="math inline">\(5 + \varepsilon\)</span>, the dual component <span class="math inline">\(\varepsilon\)</span> is considered small such that <span class="math inline">\(\varepsilon^2 = 0\)</span> then calculating <span class="math inline">\(f(5 + \varepsilon)\)</span>:</p>
<p><span class="math display">\[\begin{align}
f(5 + \varepsilon) &amp;= 5(5 + \varepsilon)^2 + 3(5 + \varepsilon) + 10,\\
&amp;= 5(25 + 10\varepsilon + \varepsilon^2) + 15 + 3\varepsilon + 10,\\
&amp;= 5\varepsilon^2 + 53\varepsilon + 150.
\end{align}\]</span></p>
<p>Then the coefficient of <span class="math inline">\(\varepsilon\)</span> is the deriviative and the constant is the evaluation of the function, <span class="math inline">\(f(5) = 150\)</span> and <span class="math inline">\(f^\prime(5) = 53\)</span>.</p>
</div>
<div id="s3-objects" class="section level2">
<h2>S3 Objects</h2>
<p>R has three systems for object oriented programming, S3, S4 and reference classes which can be learned about in the relevant chapter of <a href="http://adv-r.had.co.nz/OO-essentials.html">Advanced R</a>. Dual numbers can be implemented as an S3 class in R:</p>
<pre class="r"><code>dual &lt;- function(real, eps) {
  if (!is.numeric(real)) stop(&quot;real must be numeric&quot;)
  structure(list(real = real, eps = eps), class = &quot;dual&quot;)
} 
var &lt;- function(x) {
  if (!is.numeric(x)) stop(&quot;x must be numeric&quot;)
  dual(x, 1)
}
const &lt;- function(x) {
  if (!is.numeric(x)) stop(&quot;x must be numeric&quot;)
  dual(x, 0)
}</code></pre>
<p><code>var</code> represents a variable which we want to differentiate, whereas <code>const</code> represents a constant.</p>
<p>Next, primitive functions can be defined in terms of <code>dual</code> numbers which simultaneously evaluate the function and the derivative:</p>
<pre class="r"><code>plus &lt;- function(x, y) 
  dual(x$real + y$real, x$eps + y$eps)
minus &lt;- function(x, y) 
  dual(x$real - y$real, x$eps - y$eps)
times &lt;- function(x, y) 
  dual(x$real * y$real, x$eps * y$real + y$eps * x$real)
divide &lt;- function(x, y) 
  dual(
      x$real / y$real,
      (x$eps * y$real - x$real * y$eps) / (y$real * y$real)
    )</code></pre>
<p>Group generics can be used to implement the mathematics of dual numbers. Group generics included with base R include <code>Math</code> which includes special functions such such as <code>abs</code> and <code>sqrt</code> as well as trigonometric and hyperbolic functions. <code>Ops</code> which include the basic infix operations reqruired for arithmetic, <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code> etc. For a full list of group generics associated with <code>Math</code> and <code>Ops</code> consult the R help by typing <code>?groupGeneric</code> in the R console. In order to implement a group generic for the S3 class <code>dual</code> we implement <code>Ops.dual</code>:</p>
<pre class="r"><code>Ops.dual &lt;- function(x, y) {
  switch(
    .Generic,
    `+` = plus(x, y),
    `-` = minus(x, y),
    `*` = times(x, y),
    `/` = divide(x, y)
  )
}</code></pre>
<p><code>switch</code> is used to pattern match on the generic function being called within <code>Ops</code> by matching on <code>.Generic</code>. Implementing dual numbers in this way allows us to define a function using the in-built infix operators in a natural way. The function <span class="math inline">\(f(x)\)</span> can be defined in terms of dual numbers as</p>
<pre class="r"><code>f &lt;- function(x) 
  const(5) * x * x + const(3) * x + const(10)</code></pre>
<p>Then evaluated at <span class="math inline">\(x = 5\)</span> using the constructor <code>var</code> which initialises a dual with <span class="math inline">\(\varepsilon = 1.0\)</span>.</p>
<pre class="r"><code>f(var(5))</code></pre>
<pre><code>## $real
## [1] 150
## 
## $eps
## [1] 53
## 
## attr(,&quot;class&quot;)
## [1] &quot;dual&quot;</code></pre>
<p>The definition of <code>f</code> is cumbersome since we have to explicitly create the constants using the <code>const</code> constructor. The methods defined in <code>Ops.dual</code> can be extended to handle cases when a double is multiplied by a dual number to convert the double to a <code>const</code> and hence we can automatically differentiate any univariate function using forward mode automatic differentiation.</p>
<p>We can write a function which checks the arguments of <code>plus</code>, <code>minus</code> etc, then if the arguments aren’t explicitly dual number variables using the function <code>var</code> then they are converted to a dual constant using <code>const</code>. This function checks each argument (of a generic function of two arguments <code>f</code>) in turn to determine if they are doubles then promotes them to constants.</p>
<pre class="r"><code>lift_function &lt;- function(f) {
  function(x, y)
    if (is.double(x)) {
      f(const(x), y)
    } else if (is.double(y)) {
      f(x, const(y))
    } else {
      f(x, y)
    }
}</code></pre>
<p>The ops can then be re-defined using the <code>lift_function</code>:</p>
<pre class="r"><code>Ops.dual &lt;- function(x, y) {
  switch(
    .Generic,
    `+` = lift_function(plus)(x, y),
    `-` = lift_function(minus)(x, y),
    `*` = lift_function(times)(x, y),
    `/` = lift_function(divide)(x, y)
  )
}</code></pre>
<p>Then <code>f</code> can be defined more naturally:</p>
<pre class="r"><code>f &lt;- function(x) 
  5 * x * x + 3 * x + 10</code></pre>
<p>And the derivative calculated:</p>
<pre class="r"><code>f(var(5))</code></pre>
<pre><code>## $real
## [1] 150
## 
## $eps
## [1] 53
## 
## attr(,&quot;class&quot;)
## [1] &quot;dual&quot;</code></pre>
</div>
<div id="testing-using-hedgehog" class="section level2">
<h2>Testing using Hedgehog</h2>
<p><a href="https://github.com/hedgehogqa/r-hedgehog">Hedgehog</a> is a package which utilises <a href="https://testthat.r-lib.org">testthat</a> to implement property based testing in R. Property based testing can be used to check a wide range of inputs to a function and determine if the code outputs the expected value. In standard unit testing the state before the test is defined by programmer and typically does not change - if we were to consider a test for the derivative of the quadratic function defined above then we might write a test which evaluates the function at <span class="math inline">\(x = 5\)</span>. This verifies we are correct for <span class="math inline">\(x = 5\)</span>, but what about <span class="math inline">\(x = 0\)</span> or another value. With property based testing, we define a random generator for the input and the test checks hundreds of potential values for failure.</p>
<p>The input to this property based test is <code>a</code>, a number between <span class="math inline">\(-100\)</span> and <span class="math inline">\(100\)</span>. The usual <code>testthat</code> syntax is then used to evaluate the gradient using forward mode AD and comparing it to the exact derivative calculated by hand.</p>
<pre class="r"><code>test_that(&quot;Derivative of 5x^2 + 3x + 10&quot;,
          forall(list(a = gen.c(gen.element(
            -100:100
          ))),
          function(a)
            expect_equal(object = f(var(a))$eps, expected = 10 * a + 3)))</code></pre>
</div>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/scala.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="/js/math-code.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
  </body>
</html>

